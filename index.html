<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>hlld by armon</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>hlld</h1>
          <h2>C network daemon for HyperLogLogs</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/armon/hlld/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/armon/hlld/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/armon/hlld" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a name="hlld-" class="anchor" href="#hlld-"><span class="octicon octicon-link"></span></a>hlld <a href="https://travis-ci.org/armon/hlld"><img src="https://travis-ci.org/armon/hlld.png?branch=master" alt="Build Status"></a>
</h1>

<p>hlld is a high-performance C server which is used
to expose HyperLogLog sets and operations over them to
networked clients. It uses a simple ASCI protocol
which is human readable, and similar to memcached.</p>

<p>HyperLogLog's are a relatively new sketching data structure.
They are used to estimate cardinality, i.e. the unique number
of items in a set. They are based on the observation that any
bit in a "good" hash function is indepedenent of any other
bit and that the probability of getting a string of N
bits all set to the same value is 1/(2^N). There is a lot more in
the math, but that is the basic intuition. What is even more
incredible is that the storage required to do the counting
is log(log(N)). So with a 6 bit register, we can count well into
the trillions. For more information, its best to read the papers
referenced at the end.</p>

<p>TL;DR: HyperLogLogs enable you to have a set with about 1.6% variance,
using 3280 bytes, and estimate sizes in the trillions.</p>

<h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Scalable non-blocking core allows for many connected
clients and concurrent operations</li>
<li>Implements 6bit wide HyperLogLogs, allowing almost unbounded counts</li>
<li>Supports asynchronous flushes to disk for persistence</li>
<li>Supports non-disk backed sets for high I/O</li>
<li>Automatically faults cold sets out of memory to save resources</li>
<li>Dead simple to start and administer</li>
<li>FAST, FAST, FAST</li>
</ul><h2>
<a name="install" class="anchor" href="#install"><span class="octicon octicon-link"></span></a>Install</h2>

<p>Download and build from source:</p>

<pre><code>$ git clone https://armon@github.com/armon/hlld.git
$ cd hlld
$ pip install SCons  # Uses the Scons build system, may not be necessary
$ scons
$ ./hlld
</code></pre>

<p>This will generate some errors related to building the test code
as it depends on libcheck. To build the test code successfully,
do the following:</p>

<pre><code>$ cd deps/check-0.9.8/
$ ./configure
$ make
# make install
# ldconfig (necessary on some Linux distros)
</code></pre>

<p>Then re-build hlld. At this point, the test code should build
successfully.</p>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>hlld can be configured using a file which is in INI format.
Here is an example configuration file:</p>

<pre><code># Settings for hlld
[hlld]
tcp_port = 4553
data_dir = /mnt/hlld
log_level = INFO
flush_interval = 60
default_eps = 0.02
workers = 2
</code></pre>

<p>Then run hlld, pointing it to that file:</p>

<pre><code>hlld -f /etc/hlld.conf
</code></pre>

<p>A full list of configuration options is below.</p>

<h2>
<a name="clients" class="anchor" href="#clients"><span class="octicon octicon-link"></span></a>Clients</h2>

<p>Here is a list of known client implementations:</p>

<ul>
<li>Python : <a href="https://github.com/armon/pyhlld">https://github.com/armon/pyhlld</a>
</li>
<li>Ruby: <a href="https://github.com/mdlayher/rb-hlld">https://github.com/mdlayher/rb-hlld</a>
</li>
</ul><p>Here is a list of "best-practices" for client implementations:</p>

<ul>
<li>Maintain a set of open connections to the server to minimize connection time</li>
<li>Make use of the bulk operations when possible, as they are more efficient.</li>
<li>For long keys, it is better to do a client-side hash (SHA1 at least), and send
the hash as the key to minimize network traffic.</li>
</ul><h2>
<a name="configuration-options" class="anchor" href="#configuration-options"><span class="octicon octicon-link"></span></a>Configuration Options</h2>

<p>Each configuration option is documented below:</p>

<ul>
<li><p>tcp_port : Integer, sets the tcp port to listen on. Default 4553.</p></li>
<li><p>port: Same as above. For compatibility.</p></li>
<li><p>udp_port : Integer, sets the udp port. Currently listened on
            but otherwise unused. Default 4554.</p></li>
<li><p>bind_address: The IP address to bind on. Defaults to 0.0.0.0.</p></li>
<li><p>data_dir : The data directory that is used. Defaults to /tmp/hlld</p></li>
<li><p>log_level : The logging level that hlld should use. One of:
DEBUG, INFO, WARN, ERROR, or CRITICAL. All logs go to syslog,
and stderr if that is a TTY. Default is INFO.</p></li>
<li><p>workers : This controls the number of worker threads that are used.
Defaults to 1. If many different sets are used, it can be advantageous
to increase this to the number of CPU cores. If only a few sets are used,
the increased lock contention may reduce throughput, and a single worker
may be better.</p></li>
<li><p>flush_interval : This is the time interval in seconds in which
sets are flushed to disk. Defaults to 60 seconds. Set to 0 to
disable.</p></li>
<li><p>cold_interval : If a set is not accessed (set or bulk), for
this amount of time, it is eligible to be removed from memory
and left only on disk. If a set is accessed, it will automatically
be faulted back into memory. Set to 3600 seconds by default (1 hour).
Set to 0 to disable cold faulting.</p></li>
<li><p>in_memory : If set to 1, then all sets are in-memory ONLY by
default. This means they are not persisted to disk, and are not
eligible for cold fault out. Defaults to 0.</p></li>
<li><p>use_mmap : If set to 1, the hlld internal buffer management
is disabled, and instead buffers use a plain mmap() and rely on
the kernel for all management. This increases data safety in the
case that hlld crashes, but has adverse affects on performance
if the total memory utilization of the system is high. In general,
this should be left to 0, which is the default.</p></li>
<li><p>default_eps: If not provided to create, this is the default
error of the HyperLogLog. This is an upper bound and is used to
compute the precision that should be used. This option overrides
a given default precision. Defaults to 1.625%, which is a precision
of 12. Only one of default_eps or default_precision should be provided.</p></li>
<li><p>default_precision : If not provided to create, this is the default
"precision" of the HyperLogLog. This controls the error in the size
estimate. This option overrides a given default eps. Defaults to 12,
which is results in a variance of about 1.625%. Only one of default_eps
or default_precision should be provided.</p></li>
</ul><p>It is important to note that reducing the error bound increases the
required precision. The size utilization of a HyperLogLog increases
exponentially with the precision, so it should be increased carefully.</p>

<h2>
<a name="protocol" class="anchor" href="#protocol"><span class="octicon octicon-link"></span></a>Protocol</h2>

<p>By default, hlld will listen for TCP connections on port 4553.
It uses a simple ASCII protocol that is very similar to memcached.</p>

<p>A command has the following syntax::</p>

<pre><code>cmd [args][\r]\n
</code></pre>

<p>We start each line by specifying a command, providing optional arguments,
and ending the line in a newline (carriage return is optional).</p>

<p>There are a total of 9 commands:</p>

<ul>
<li>create - Create a new set (a set is a named HyperLogLog)</li>
<li>list - List all sets or those matching a prefix</li>
<li>drop - Drop a set (Deletes from disk)</li>
<li>close - Closes a set (Unmaps from memory, but still accessible)</li>
<li>clear - Clears a set from the lists (Removes memory, left on disk)</li>
<li>set|s - Set an item in a set</li>
<li>bulk|b - Set many items in a set at once</li>
<li>info - Gets info about a set</li>
<li>flush - Flushes all sets or just a specified one</li>
</ul><p>For the <code>create</code> command, the format is::</p>

<pre><code>create set_name [precision=prec] [eps=max_eps] [in_memory=0|1]
</code></pre>

<p>Where <code>set_name</code> is the name of the set,
and can contain the characters a-z, A-Z, 0-9, ., <em>.
If a precision is provided the set
will be created with the given bits of precision, otherwise the configured default value will be used.
If a maximum epsilon is provided, that will be used to compute a precision, otherwise the configured default is used.
You can optionally specify in</em>memory to force the set to not be persisted to disk. If both precision and
eps are specified, it is not specified which one will be used. Generally, only one should be provided,
as the other will be computed.</p>

<p>As an example::</p>

<pre><code>create foobar eps=0.01
</code></pre>

<p>This will create a set foobar that has a maximum variance of 1%.
Valid responses are either "Done", "Exists", or "Delete in progress". The last response
occurs if a set of the same name was recently deleted, and hlld
has not yet completed the delete operation. If so, a client should
retry the create in a few seconds.</p>

<p>The <code>list</code> command takes either no arguments or a set prefix, and returns information
about the matching sets.</p>

<p>For example, doing:</p>

<pre><code>list foo
</code></pre>

<p>Will return a list of all sets with the foo prefix. Here is an example response:</p>

<pre><code>START
foobar 0.010000 14 13108 0
END
</code></pre>

<p>This indicates a single set named foobar, with a variance
of 0.02, precision 12, a 4096 byte size, a current size estimate of 1540
items.</p>

<p>The <code>drop</code>, <code>close</code> and <code>clear</code> commands are like create, but only takes a set name.
It can either return "Done" or "Set does not exist". <code>clear</code> can also return "Set is not proxied. Close it first.".
This means that the set is still in-memory and not qualified for being cleared.
This can be resolved by first closing the set.</p>

<p>set is a very simple command:</p>

<pre><code>set set_name key
</code></pre>

<p>The command must specify a set and a key to use.
It will either return "Done", or "Set does not exist".</p>

<p>The bulk command is similar to set but allows for many keys
to be set at once. Keys must be separated by a space:</p>

<pre><code>bulk set_name key1 [key_2 [key_3 [key_N]]]
</code></pre>

<p>The bulk and set commands can also be called by their aliasses
b and s respectively.</p>

<p>The <code>info</code> command takes a set name, and returns
information about the set. Here is an example output:</p>

<pre><code>START
in_memory 1
page_ins 0
page_outs 0
eps 0.02
precision 12
sets 0
size 1540
storage 3280
END
</code></pre>

<p>The command may also return "Set does not exist" if the set does
not exist.</p>

<p>The <code>flush</code> command may be called without any arguments, which
causes all sets to be flushed. If a set name is provided
then that set will be flushed. This will either return "Done" or
"Set does not exist".</p>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>Here is an example of a client flow, assuming hlld is
running on the default port using just telnet::</p>

<pre><code>$ telnet localhost 4553
&gt; list
START
END

&gt; create foobar
Done

&gt; set foobar zipzab
Done

&gt; bulk foobar zipzab blah boo
Done

&gt; list
START
foobar 0.016250 12 3280 3
END

&gt; drop foobar
Done

&gt; list
START
END
</code></pre>

<h2>
<a name="performance" class="anchor" href="#performance"><span class="octicon octicon-link"></span></a>Performance</h2>

<p>Although extensive performance evaluations have not been done,
casual testing on a 2012 MBP with pure set operations
allows for a throughput of at least 1MM ops/sec. On Linux,
response times can be as low as 1 μs.</p>

<p>hlld also supports multi-core systems for scalability, so
it is important to tune it for the given work load. The number
of worker threads can be configured either in the configuration
file, or by providing a <code>-w</code> flag. This should be set to at most
2 * CPU count. By default, only a single worker is used.</p>

<h2>
<a name="references" class="anchor" href="#references"><span class="octicon octicon-link"></span></a>References</h2>

<p>Here are some related works which we make use of:</p>

<ul>
<li>HyperLogLog in Practice: Algorithmic Engineering of a State of The Art Cardinality Estimation Algorithm : <a href="http://research.google.com/pubs/pub40671.html">http://research.google.com/pubs/pub40671.html</a>
</li>
<li>HyperLogLog: The analysis of a near-optimal cardinality estimation algorithm : <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.142.9475">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.142.9475</a>
</li>
</ul>
        </section>

        <footer>
          hlld is maintained by <a href="https://github.com/armon">armon</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>